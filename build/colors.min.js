/*!
color-tunes.coffee
Copyright 2012 Shao-Chung Chen. Modified 2013 Oliver Chang.
Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php)
*/
(function(){var t,o,r,n;r=function(t,o,r,n,i,e){var s,h,u,c,f,p,a,g,l,b;for(null==e&&(e=8),u=t.getContext("2d").getImageData(o,r,n,i).data,c=[],p=a=r,l=r+i;l>a;p=a+=1)for(h=4*p*n,f=g=o,b=o+n;b>g;f=g+=1)s=h+4*f,c.push([u[s],u[s+1],u[s+2]]);return(new MMCQ).quantize(c,e)},o=function(t,o){var r;return r=function(t){return t*t},r(t[0]-o[0])+r(t[1]-o[1])+r(t[2]-o[2])},n=function(t){var o,r,n,i,e;for(o=function(t){return t=t.toString(16),t.length<2?t+="0":t},e=[],n=0,i=t.length;i>n;n++)r=t[n],e.push(r.map(o).join(""));return e},this.color=function(t,i){var e,s;return null==t&&(t="palette-image"),s=new Image,s.src=document.getElementById(t).src,e=document.createElement("canvas"),window.onload=function(){var t,h,u,c,f,p,a,g;return s.height=s.width=36,e.width=s.width,e.height=s.height,e.getContext("2d").drawImage(s,0,0,s.width,s.height),h=r(e,0,0,s.width,s.height,10),g=h.cboxes.map(function(t){return{count:t.cbox.count(),rgb:t.color}}),g.sort(function(t,o){return o.count-t.count}),t=g.shift().rgb,c=function(r){return o(t,r.rgb)},a=g,g.sort(function(t,o){return c(o)-c(t)}),f=a.shift().rgb,p=a.shift().rgb,u=n([t,f,p]),i?i(u):void 0}},/*!
  quantize.coffee, Copyright 2012 Shao-Chung Chen.
  Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php)
  */
t=function(){function t(t){this.comparator=t,this.contents=[],this.sorted=!1}return t.prototype.sort=function(){return this.contents.sort(this.comparator),this.sorted=!0},t.prototype.push=function(t){return this.contents.push(t),this.sorted=!1},t.prototype.peek=function(t){return null==t&&(t=this.contents.length-1),this.sorted||this.sort(),this.contents[t]},t.prototype.pop=function(){return this.sorted||this.sort(),this.contents.pop()},t.prototype.size=function(){return this.contents.length},t.prototype.map=function(t){return this.contents.map(t)},t}(),this.MMCQ=function(){function o(){this.maxIterations=1e3,this.fractByPopulations=.75}var r,n,i,e,s,h;return o.sigbits=5,o.rshift=8-o.sigbits,e=function(t,r,n){return(t<<2*o.sigbits)+(r<<o.sigbits)+n},r=function(){function t(t,o,r,n,i,e,s){this.r1=t,this.r2=o,this.g1=r,this.g2=n,this.b1=i,this.b2=e,this.histo=s}return t.prototype.volume=function(t){return(!this._volume||t)&&(this._volume=(this.r2-this.r1+1)*(this.g2-this.g1+1)*(this.b2-this.b1+1)),this._volume},t.prototype.count=function(t){var o,r,n,i,s,h,u,c,f,p,a,g,l,b;if(!this._count_set||t){for(i=0,s=h=f=this.r1,p=this.r2;p>=h;s=h+=1)for(r=u=a=this.g1,g=this.g2;g>=u;r=u+=1)for(o=c=l=this.b1,b=this.b2;b>=c;o=c+=1)n=e(s,r,o),i+=this.histo[n]||0;this._count_set=!0,this._count=i}return this._count},t.prototype.copy=function(){return new t(this.r1,this.r2,this.g1,this.g2,this.b1,this.b2,this.histo)},t.prototype.average=function(t){var r,n,i,s,h,u,c,f,p,a,g,l,b,v,m,d,x,y,w;if(!this._average||t){for(c=1<<8-o.sigbits,a=0,p=0,s=0,n=0,f=g=v=this.r1,m=this.r2;m>=g;f=g+=1)for(i=l=d=this.g1,x=this.g2;x>=l;i=l+=1)for(r=b=y=this.b1,w=this.b2;w>=b;r=b+=1)u=e(f,i,r),h=this.histo[u]||0,a+=h,p+=h*(f+.5)*c,s+=h*(i+.5)*c,n+=h*(r+.5)*c;this._average=a?[~~(p/a),~~(s/a),~~(n/a)]:[~~(c*(this.r1+this.r2+1)/2),~~(c*(this.g1+this.g2+1)/2),~~(c*(this.b1+this.b2+1)/2)]}return this._average},t.prototype.contains=function(t){var r,n,i;return i=t[0]>>o.rshift,n=t[1]>>o.rshift,r=t[2]>>o.rshift,this.r1<=i&&i<=this.r2&&this.g1<=n&&n<=this.g2&&this.b1<=r&&r<=this.b2},t}(),n=function(){function o(){this.cboxes=new t(function(t,o){var r,n;return r=t.count()*t.volume(),n=o.count()*o.volume(),r>n?1:n>r?-1:0})}return o.prototype.push=function(t){return this.cboxes.push({cbox:t,color:t.average()})},o.prototype.palette=function(){return this.cboxes.map(function(t){return t.color})},o.prototype.size=function(){return this.cboxes.size()},o.prototype.map=function(t){var o,r,n;for(o=r=0,n=this.cboxes.size();n>r;o=r+=1)return this.cboxes.peek(o).cbox.contains(t)?this.cboxes.peek(o).color:this.nearest(t)},o.prototype.cboxes=function(){return this.cboxes},o.prototype.nearest=function(t){var o,r,n,i,e,s,h;for(e=function(t){return t*t},n=1e9,r=s=0,h=this.cboxes.size();h>s;r=s+=1)o=Math.sqrt(e(t[0]-this.cboxes.peek(r).color[0])+e(t[1]-this.cboxes.peek(r).color[1])+e(t[2]-this.cboxes.peek(r).color[2])),n>o&&(n=o,i=this.cboxes.peek(r).color);return i},o}(),s=function(t){var r,n,i,s,h,u,c,f,p;for(s=1<<3*o.sigbits,i=new Array(s),f=0,p=t.length;p>f;f++)u=t[f],c=u[0]>>o.rshift,n=u[1]>>o.rshift,r=u[2]>>o.rshift,h=e(c,n,r),i[h]=(i[h]||0)+1;return i},i=function(t,n){var i,e,s,h,u,c,f,p,a,g,l,b;for(g=1e6,a=0,c=1e6,u=0,s=1e6,e=0,l=0,b=t.length;b>l;l++)f=t[l],p=f[0]>>o.rshift,h=f[1]>>o.rshift,i=f[2]>>o.rshift,g>p?g=p:p>a&&(a=p),c>h?c=h:h>u&&(u=h),s>i?s=i:i>e&&(e=i);return new r(g,a,c,u,s,e,n)},h=function(t,o){var r,n,i,s,h,u,c,f,p,a,g,l,b,v,m,d,x,y,w,_,z,M,k,I,C,q,B,E,P,Q,j,A,D,S,F,G,H,J,K,L;if(o.count()){if(1===o.count())return[o.copy()];if(g=o.r2-o.r1+1,h=o.g2-o.g1+1,n=o.b2-o.b1+1,f=Math.max(g,h,n),b=0,p=[],c=[],f===g)for(a=v=k=o.r1,I=o.r2;I>=v;a=v+=1){for(l=0,s=m=D=o.g1,S=o.g2;S>=m;s=m+=1)for(r=d=F=o.b1,G=o.b2;G>=d;r=d+=1)u=e(a,s,r),l+=t[u]||0;b+=l,p[a]=b}else if(f===h)for(s=x=H=o.g1,J=o.g2;J>=x;s=x+=1){for(l=0,a=y=K=o.r1,L=o.r2;L>=y;a=y+=1)for(r=w=C=o.b1,q=o.b2;q>=w;r=w+=1)u=e(a,s,r),l+=t[u]||0;b+=l,p[s]=b}else for(r=_=B=o.b1,E=o.b2;E>=_;r=_+=1){for(l=0,a=z=P=o.r1,Q=o.r2;Q>=z;a=z+=1)for(s=M=j=o.g1,A=o.g2;A>=M;s=M+=1)u=e(a,s,r),l+=t[u]||0;b+=l,p[r]=b}return p.forEach(function(t,o){return c[o]=b-t}),i=function(t){var r,n,i,e,s,h,u,f,a,g,l,v;for(s=t+"1",h=t+"2",u=g=l=o[s],v=o[h];v>=g;u=g+=1)if(p[u]>b/2){for(r=o.copy(),n=o.copy(),f=u-o[s],a=o[h]-u,e=a>=f?Math.min(o[h]-1,~~(u+a/2)):Math.max(o[s],~~(u-1-f/2));!p[e];)e++;for(i=c[e];!i&&p[e-1];)i=c[--e];return r[h]=e,n[s]=r[h]+1,[r,n]}},f===g?i("r"):f===h?i("g"):f===n?i("b"):void 0}},o.prototype.quantize=function(o,r){var e,u,c,f,p,a,g=this;if(!o.length||2>r||r>256)return console.log("invalid arguments"),!1;for(c=s(o),e=i(o,c),p=new t(function(t,o){var r,n;return r=t.count(),n=o.count(),r>n?1:n>r?-1:0}),p.push(e),f=function(t,o){var r,n,i,s,u;for(s=1,u=0;u<g.maxIterations;)if(e=t.pop(),e.count()){if(i=h(c,e),r=i[0],n=i[1],!r)return console.log("cbox1 not defined; shouldn't happen"),void 0;if(t.push(r),n&&(t.push(n),s++),s>=o)return;if(u++>g.maxIterations)return console.log("infinite loop; perhaps too few pixels"),void 0}else t.push(e),u++},f(p,this.fractByPopulations*r),a=new t(function(t,o){var r,n;return r=t.count()*t.volume(),n=o.count()*o.volume(),r>n?1:n>r?-1:0});p.size();)a.push(p.pop());for(f(a,r-a.size()),u=new n;a.size();)u.push(a.pop());return u},o}.call(this)}).call(this);