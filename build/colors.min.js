/*
color-tunes.coffee
Copyright 2012 Shao-Chung Chen. Modified 2013 Oliver Chang.
Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php)
*/
(function(){var b,c,d,a;d=function(e,s,q,t,m,l){var n,u,o,f,r,p,j,i,k,g;if(l==null){l=8}o=e.getContext("2d").getImageData(s,q,t,m).data;f=[];for(p=j=q,k=q+m;j<k;p=j+=1){u=p*t*4;for(r=i=s,g=s+t;i<g;r=i+=1){n=u+(r*4);f.push([o[n],o[n+1],o[n+2]])}}return(new MMCQ).quantize(f,l)};c=function(f,e){var g;g=function(h){return h*h};return g(f[0]-e[0])+g(f[1]-e[1])+g(f[2]-e[2])};a=function(h,k,m){var f,j,e,i,l,g;if(m==null){m="color"}j=document.getElementsByClassName(k);h="rgb("+h[0]+", "+h[1]+", "+h[2]+")";g=[];for(i=0,l=j.length;i<l;i++){f=j[i];e=f.getAttribute("style");g.push(f.setAttribute("style",""+e+" "+m+": "+h+";"))}return g};this.color=function(f,g,h){var e,i;if(h==null){h="palette-image"}i=new Image;i.src=document.getElementById(h).src;e=document.getElementById(f);return window.onload=function(){var n,l,m,o,p,k,j;i.height=i.width=36;e.width=i.width;e.height=i.height;e.getContext("2d").drawImage(i,0,0,i.width,i.height);l=d(e,0,0,i.width,i.height,10);j=l.cboxes.map(function(q){return{count:q.cbox.count(),rgb:q.color}});j.sort(function(r,q){return q.count-r.count});n=j.shift().rgb;m=function(q){return c(n,q.rgb)};k=j;j.sort(function(r,q){return m(q)-m(r)});o=k.shift().rgb;p=k.shift().rgb;console.log([n,o,p]);a(n,g.bgClass,"background-color");a(o,g.fgClass,"background-color");return a(p,g.fgClass2,"background-color")}};
/*
  quantize.coffee, Copyright 2012 Shao-Chung Chen.
  Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php)
  */
b=(function(){function e(f){this.comparator=f;this.contents=[];this.sorted=false}e.prototype.sort=function(){this.contents.sort(this.comparator);return this.sotred=true};e.prototype.push=function(f){this.contents.push(f);return this.sorted=false};e.prototype.peek=function(f){if(f==null){f=this.contents.length-1}if(!this.sorted){this.sort()}return this.contents[f]};e.prototype.pop=function(){if(!this.sorted){this.sort()}return this.contents.pop()};e.prototype.size=function(){return this.contents.length};e.prototype.map=function(f){return this.contents.map(f)};return e})();this.MMCQ=(function(){var e,f,h,g,j,k,l=this;i.sigbits=5;i.rshift=8-i.sigbits;function i(){this.maxIterations=1000;this.fractByPopulations=0.75}g=function(o,n,m){return(o<<(2*i.sigbits))+(n<<i.sigbits)+m};e=(function(){function m(s,o,r,n,t,q,p){this.r1=s;this.r2=o;this.g1=r;this.g2=n;this.b1=t;this.b2=q;this.histo=p}m.prototype.volume=function(n){if(!this._volume||n){this._volume=(this.r2-this.r1+1)*(this.g2-this.g1+1)*(this.b2-this.b1+1)}return this._volume};m.prototype.count=function(C){var B,y,z,A,n,w,v,t,x,u,s,q,p,o;if(!this._count_set||C){A=0;for(n=w=x=this.r1,u=this.r2;w<=u;n=w+=1){for(y=v=s=this.g1,q=this.g2;v<=q;y=v+=1){for(B=t=p=this.b1,o=this.b2;t<=o;B=t+=1){z=g(n,y,B);A+=this.histo[z]||0}}}this._count_set=true;this._count=A}return this._count};m.prototype.copy=function(){return new m(this.r1,this.r2,this.g1,this.g2,this.b1,this.b2,this.histo)};m.prototype.average=function(G){var F,D,E,A,B,y,x,C,t,H,u,q,o,z,w,v,s,p,n;if(!this._average||G){x=1<<(8-i.sigbits);H=0;t=0;A=0;D=0;for(C=u=z=this.r1,w=this.r2;u<=w;C=u+=1){for(E=q=v=this.g1,s=this.g2;q<=s;E=q+=1){for(F=o=p=this.b1,n=this.b2;o<=n;F=o+=1){y=g(C,E,F);B=this.histo[y]||0;H+=B;t+=B*(C+0.5)*x;A+=B*(E+0.5)*x;D+=B*(F+0.5)*x}}}if(H){this._average=[~~(t/H),~~(A/H),~~(D/H)]}else{this._average=[~~(x*(this.r1+this.r2+1)/2),~~(x*(this.g1+this.g2+1)/2),~~(x*(this.b1+this.b2+1)/2)]}}return this._average};m.prototype.contains=function(o){var n,q,p;p=o[0]>>i.rshift;q=o[1]>>i.rshift;n=o[2]>>i.rshift;return((this.r1<=p&&p<=this.r2))&&((this.g1<=q&&q<=this.g2))&&((this.b1<=n&&n<=this.b2))};return m})();f=(function(){function m(){this.cboxes=new b(function(o,n){var q,p;q=o.count()*o.volume();p=n.count()*n.volume();if(q>p){return 1}else{if(q<p){return -1}else{return 0}}})}m.prototype.push=function(n){return this.cboxes.push({cbox:n,color:n.average()})};m.prototype.palette=function(){return this.cboxes.map(function(n){return n.color})};m.prototype.size=function(){return this.cboxes.size()};m.prototype.map=function(n){var o,q,p;for(o=q=0,p=this.cboxes.size();q<p;o=q+=1){if(this.cboxes.peek(o).cbox.contains(n)){return this.cboxes.peek(o).color}return this.nearest(n)}};m.prototype.cboxes=function(){return this.cboxes};m.prototype.nearest=function(o){var u,q,n,p,t,s,r;t=function(v){return v*v};n=1000000000;for(q=s=0,r=this.cboxes.size();s<r;q=s+=1){u=Math.sqrt(t(o[0]-this.cboxes.peek(q).color[0])+t(o[1]-this.cboxes.peek(q).color[1])+t(o[2]-this.cboxes.peek(q).color[2]));if(u<n){n=u;p=this.cboxes.peek(q).color}}return p};return m})();j=function(o){var v,t,q,s,u,n,m,p,w;s=1<<(3*i.sigbits);q=new Array(s);for(p=0,w=o.length;p<w;p++){n=o[p];m=n[0]>>i.rshift;t=n[1]>>i.rshift;v=n[2]>>i.rshift;u=g(m,t,v);q[u]=(q[u]||0)+1}return q};h=function(p,s){var w,o,y,t,z,u,n,m,A,v,q,x;v=1000000;A=0;u=1000000;z=0;y=1000000;o=0;for(q=0,x=p.length;q<x;q++){n=p[q];m=n[0]>>i.rshift;t=n[1]>>i.rshift;w=n[2]>>i.rshift;if(m<v){v=m}else{if(m>A){A=m}}if(t<u){u=t}else{if(t>z){z=t}}if(w<y){y=w}else{if(w>o){o=w}}}return new e(v,A,u,z,y,o,s)};k=function(A,K){var aa,G,m,U,o,F,p,n,q,I,D,C,E,S,R,Q,P,O,N,M,L,J,H,B,ac,ab,Z,Y,X,W,V,T,z,y,x,w,v,u,t,s;if(!K.count()){return}if(K.count()===1){return[K.copy()]}D=K.r2-K.r1+1;o=K.g2-K.g1+1;G=K.b2-K.b1+1;n=Math.max(D,o,G);E=0;q=[];p=[];if(n===D){for(I=S=H=K.r1,B=K.r2;S<=B;I=S+=1){C=0;for(U=R=z=K.g1,y=K.g2;R<=y;U=R+=1){for(aa=Q=x=K.b1,w=K.b2;Q<=w;aa=Q+=1){F=g(I,U,aa);C+=A[F]||0}}E+=C;q[I]=E}}else{if(n===o){for(U=P=v=K.g1,u=K.g2;P<=u;U=P+=1){C=0;for(I=O=t=K.r1,s=K.r2;O<=s;I=O+=1){for(aa=N=ac=K.b1,ab=K.b2;N<=ab;aa=N+=1){F=g(I,U,aa);C+=A[F]||0}}E+=C;q[U]=E}}else{for(aa=M=Z=K.b1,Y=K.b2;M<=Y;aa=M+=1){C=0;for(I=L=X=K.r1,W=K.r2;L<=W;I=L+=1){for(U=J=V=K.g1,T=K.g2;J<=T;U=J+=1){F=g(I,U,aa);C+=A[F]||0}}E+=C;q[aa]=E}}}q.forEach(function(ad,r){return p[r]=E-ad});m=function(ag){var ae,ad,ak,r,am,al,ah,af,an,ao,aj,ai;am=ag+"1";al=ag+"2";for(ah=ao=aj=K[am],ai=K[al];ao<=ai;ah=ao+=1){if(q[ah]>(E/2)){ae=K.copy();ad=K.copy();af=ah-K[am];an=K[al]-ah;if(af<=an){r=Math.min(K[al]-1,~~(ah+an/2))}else{r=Math.max(K[am],~~(ah-1-af/2))}while(!q[r]){r++}ak=p[r];while(!ak&&q[r-1]){ak=p[--r]}ae[al]=r;ad[am]=ae[al]+1;return[ae,ad]}}};if(n===D){return m("r")}if(n===o){return m("g")}if(n===G){return m("b")}};i.prototype.quantize=function(o,s){var r,n,p,t,m,u,q=this;if((!o.length)||(s<2)||(s>256)){console.log("invalid arguments");return false}p=j(o);r=h(o,p);m=new b(function(w,v){var y,x;y=w.count();x=v.count();if(y>x){return 1}else{if(y<x){return -1}else{return 0}}});m.push(r);t=function(w,B){var x,v,A,z,y;z=1;y=0;while(y<q.maxIterations){r=w.pop();if(!r.count()){w.push(r);y++;continue}A=k(p,r);x=A[0];v=A[1];if(!x){console.log("cbox1 not defined; shouldn't happen");return}w.push(x);if(v){w.push(v);z++}if(z>=B){return}if((y++)>q.maxIterations){console.log("infinite loop; perhaps too few pixels");return}}};t(m,this.fractByPopulations*s);u=new b(function(w,v){var y,x;y=w.count()*w.volume();x=v.count()*v.volume();if(y>x){return 1}else{if(y<x){return -1}else{return 0}}});while(m.size()){u.push(m.pop())}t(u,s-u.size());n=new f;while(u.size()){n.push(u.pop())}return n};return i}).call(this)}).call(this);