(function(){var z,B,C,D;C=function(a,k,e,g,t,n){var p,d,b,c,E;null==n&&(n=8);a=a.getContext("2d").getImageData(k,e,g,t).data;d=[];b=c=e;for(e+=t;c<e;b=c+=1)for(t=b*g*4,p=b=k,E=k+g;b<E;p=b+=1)p=t+4*p,d.push([a[p],a[p+1],a[p+2]]);return(new MMCQ).quantize(d,n)};B=function(a,k){var e;e=function(a){return a*a};return e(a[0]-k[0])+e(a[1]-k[1])+e(a[2]-k[2])};D=function(a){var k,e,g,t,n;k=function(a){a=a.toString(16);return 2>a.length?a+"0":a};n=[];g=0;for(t=a.length;g<t;g++)e=a[g],n.push(e.map(k).join(""));
return n};this.color=function(a,k){var e,g;null==a&&(a="palette-image");g=new Image;g.src=document.getElementById(a).src;e=document.createElement("canvas");return window.onload=function(){var a,n,p,d;g.height=g.width=36;e.width=g.width;e.height=g.height;e.getContext("2d").drawImage(g,0,0,g.width,g.height);d=C(e,0,0,g.width,g.height,10).cboxes.map(function(b){return{count:b.cbox.count(),rgb:b.color}});d.sort(function(b,c){return c.count-b.count});a=d.shift().rgb;p=function(b){return B(a,b.rgb)};d.sort(function(b,
c){return p(c)-p(b)});n=d.shift().rgb;d=d.shift().rgb;n=D([a,n,d]);if(k)return k(n)}};z=function(){function a(a){this.comparator=a;this.contents=[];this.sorted=!1}a.prototype.sort=function(){this.contents.sort(this.comparator);return this.sorted=!0};a.prototype.push=function(a){this.contents.push(a);return this.sorted=!1};a.prototype.peek=function(a){null==a&&(a=this.contents.length-1);this.sorted||this.sort();return this.contents[a]};a.prototype.pop=function(){this.sorted||this.sort();return this.contents.pop()};
a.prototype.size=function(){return this.contents.length};a.prototype.map=function(a){return this.contents.map(a)};return a}();this.MMCQ=function(){function a(){this.maxIterations=1E3;this.fractByPopulations=0.75}var k,e,g,t,n,p;a.sigbits=5;a.rshift=8-a.sigbits;t=function(d,b,c){return(d<<2*a.sigbits)+(b<<a.sigbits)+c};k=function(){function d(b,c,a,d,h,f,m){this.r1=b;this.r2=c;this.g1=a;this.g2=d;this.b1=h;this.b2=f;this.histo=m}d.prototype.volume=function(b){if(!this._volume||b)this._volume=(this.r2-
this.r1+1)*(this.g2-this.g1+1)*(this.b2-this.b1+1);return this._volume};d.prototype.count=function(b){var c,a,d,h,f,m,r,q,s;if(!this._count_set||b){a=0;d=h=this.r1;for(r=this.r2;h<=r;d=h+=1)for(b=f=this.g1,q=this.g2;f<=q;b=f+=1)for(c=m=this.b1,s=this.b2;m<=s;c=m+=1)c=t(d,b,c),a+=this.histo[c]||0;this._count_set=!0;this._count=a}return this._count};d.prototype.copy=function(){return new d(this.r1,this.r2,this.g1,this.g2,this.b1,this.b2,this.histo)};d.prototype.average=function(b){var c,d,l,h,f,m,r,
q,s,u,A,g,e,k;if(!this._average||b){f=1<<8-a.sigbits;c=l=r=q=0;m=s=this.r1;for(g=this.r2;s<=g;m=s+=1)for(d=u=this.g1,e=this.g2;u<=e;d=u+=1)for(b=A=this.b1,k=this.b2;A<=k;b=A+=1)h=t(m,d,b),h=this.histo[h]||0,q+=h,r+=h*(m+0.5)*f,l+=h*(d+0.5)*f,c+=h*(b+0.5)*f;this._average=q?[~~(r/q),~~(l/q),~~(c/q)]:[~~(f*(this.r1+this.r2+1)/2),~~(f*(this.g1+this.g2+1)/2),~~(f*(this.b1+this.b2+1)/2)]}return this._average};d.prototype.contains=function(b){var c,d;d=b[0]>>a.rshift;c=b[1]>>a.rshift;b=b[2]>>a.rshift;return this.r1<=
d&&d<=this.r2&&this.g1<=c&&c<=this.g2&&this.b1<=b&&b<=this.b2};return d}();e=function(){function a(){this.cboxes=new z(function(b,a){var d,l;d=b.count()*b.volume();l=a.count()*a.volume();return d>l?1:d<l?-1:0})}a.prototype.push=function(b){return this.cboxes.push({cbox:b,color:b.average()})};a.prototype.palette=function(){return this.cboxes.map(function(b){return b.color})};a.prototype.size=function(){return this.cboxes.size()};a.prototype.map=function(b){var a;for(a=this.cboxes.size();0<a;)return this.cboxes.peek(0).cbox.contains(b)?
this.cboxes.peek(0).color:this.nearest(b)};a.prototype.cboxes=function(){return this.cboxes};a.prototype.nearest=function(b){var a,d,l,h,f,m,r;f=function(b){return b*b};l=1E9;d=m=0;for(r=this.cboxes.size();m<r;d=m+=1)a=Math.sqrt(f(b[0]-this.cboxes.peek(d).color[0])+f(b[1]-this.cboxes.peek(d).color[1])+f(b[2]-this.cboxes.peek(d).color[2])),a<l&&(l=a,h=this.cboxes.peek(d).color);return h};return a}();n=function(d){var b,c,g,l,h,f;g=Array(1<<3*a.sigbits);h=0;for(f=d.length;h<f;h++)b=d[h],l=b[0]>>a.rshift,
c=b[1]>>a.rshift,b=b[2]>>a.rshift,c=t(l,c,b),g[c]=(g[c]||0)+1;return g};g=function(d,b){var c,g,l,h,f,m,r,q,s,u,e;s=1E6;q=0;m=1E6;f=0;l=1E6;u=g=0;for(e=d.length;u<e;u++)c=d[u],r=c[0]>>a.rshift,h=c[1]>>a.rshift,c=c[2]>>a.rshift,r<s?s=r:r>q&&(q=r),h<m?m=h:h>f&&(f=h),c<l?l=c:c>g&&(g=c);return new k(s,q,m,f,l,g,b)};p=function(a,b){var c,g,l,h,f,m,r,q,s,u,e,k,n,p,v,w,x,y;if(b.count()){if(1===b.count())return[b.copy()];u=b.r2-b.r1+1;h=b.g2-b.g1+1;g=b.b2-b.b1+1;r=Math.max(u,h,g);k=0;q=[];m=[];if(r===u)for(s=
n=b.r1,w=b.r2;n<=w;s=n+=1){e=0;l=p=b.g1;for(x=b.g2;p<=x;l=p+=1)for(c=v=b.b1,y=b.b2;v<=y;c=v+=1)f=t(s,l,c),e+=a[f]||0;k+=e;q[s]=k}else if(r===h)for(l=n=b.g1,x=b.g2;n<=x;l=n+=1){e=0;s=p=b.r1;for(y=b.r2;p<=y;s=p+=1)for(c=v=b.b1,w=b.b2;v<=w;c=v+=1)f=t(s,l,c),e+=a[f]||0;k+=e;q[l]=k}else for(c=n=b.b1,w=b.b2;n<=w;c=n+=1){e=0;s=p=b.r1;for(x=b.r2;p<=x;s=p+=1)for(l=v=b.g1,y=b.g2;v<=y;l=v+=1)f=t(s,l,c),e+=a[f]||0;k+=e;q[c]=k}q.forEach(function(b,a){return m[a]=k-b});c=function(a){var c,d,e,f,g,h;g=a+"1";a+=
"2";e=c=b[g];for(d=b[a];c<=d;e=c+=1)if(q[e]>k/2){c=b.copy();d=b.copy();f=e-b[g];h=b[a]-e;for(f=f<=h?Math.min(b[a]-1,~~(e+h/2)):Math.max(b[g],~~(e-1-f/2));!q[f];)f++;for(e=m[f];!e&&q[f-1];)e=m[--f];c[a]=f;d[g]=c[a]+1;return[c,d]}};if(r===u)return c("r");if(r===h)return c("g");if(r===g)return c("b")}};a.prototype.quantize=function(a,b){var c,k,l,h,f,m=this;if(!a.length||2>b||256<b)return console.log("invalid arguments"),!1;l=n(a);c=g(a,l);h=new z(function(a,b){var c,d;c=a.count();d=b.count();return c>
d?1:c<d?-1:0});h.push(c);k=function(a,b){var d,e,f,g;f=1;for(g=0;g<m.maxIterations;)if(c=a.pop(),c.count()){e=p(l,c);d=e[0];e=e[1];if(!d){console.log("cbox1 not defined; shouldn't happen");break}a.push(d);e&&(a.push(e),f++);if(f>=b)break;if(g++>m.maxIterations){console.log("infinite loop; perhaps too few pixels");break}}else a.push(c),g++};k(h,this.fractByPopulations*b);for(f=new z(function(a,b){var c,d;c=a.count()*a.volume();d=b.count()*b.volume();return c>d?1:c<d?-1:0});h.size();)f.push(h.pop());
k(f,b-f.size());for(k=new e;f.size();)k.push(f.pop());return k};return a}.call(this)}).call(this);
